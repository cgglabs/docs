---
slug: foc
title: Field Oriented Control (FOC)
authors: carlos
tags: [Motors, FOC]
draft: false
---

# Field Oriented Control (FOC)

Field Oriented Control is often considered a dark art filled with diagrams, math, and proofs by intimidation. 

Often people will show a diagram like this,

<div style={{textAlign: 'center'}}>

![FOC Diagram](/img/foc-block-diagram.png)

</div>

and pretend like it's self explanatory.

Not true!

However, once you get an understanding of what the different pieces are and what they are trying to do, you'll realize that it can be quite intuitive.

Let's dive in.

<!-- truncate -->

## 1. How does a motor work?

Let's start with the humble goal of understanding how a motor works.

When you run a current through a wire, you get a magnetic field around the wire.

<div style={{textAlign: 'center'}}>
![Magnetic field around a current-carrying wire](/img/faradays-law.jpg)
</div>

If I put a permanent magnet like a compass next to the wire, the magnetic field of the compass interacts with the magnetic field around the wire which causes the compass to be deflected. 

<div style={{textAlign: 'center'}}>
![Wire deflecting compass](/img/wire-deflecting-compass.gif)
</div>

This is a result of the north and south poles of each field being attracted to each other and trying to align.

A motor works in the same way.

<div style={{textAlign: 'center'}}>
![Brushless Motor](/img/BLDC-Motor.gif)
</div>

Inside of the motor there are both permanent magnets and wires. When you run a current through the wires inside the motor, the magnetic field of the wire interacts with the magnetic field of the permanent magnets -- just like the compass and wire we talked about before.

As you can see in the image above, there are two main parts of a motor: a rotor and a stator. 

The rotor is free to rotate and the stator is stationary.

The permanent magnets are attached to the rotor and the wire is wrapped around specific parts of the stator.

Now if I start to run current through the wire, I get a magnetic field that starts to interact with the magnetic field of the permanent magnets. Since the permanent magnets on the rotor are free to rotate, the rotor will rotate to try to align its magnetic field with the one created by the wire. And so, we get a rotation. Success!

This type of motor is called a brushless DC motor and a variant of it called a Permanent Magnet Synchronous Motor (PMSM) is what we'll be focusing on in this post.

Before we move on, you might have noticed that in the motor image above current is always flowing through two of the wires. This is because one of the wires always interacts with the south pole (blue in the image) and the other wire interacts with the north pole (red). You can think of this as one magnetic field "pushing" while the other is "pulling" since two poles of the same polarity repel each other while poles of opposite polarity attract.

Lastly, depending on the motor design, there may also be sensors inside the motor that provide position data like hall-effect sensors or encoders. We'll touch on these later.


## 2. How to spin efficiently
Okay, so we know that putting current through the motor wires makes the motor spin, but how do we know when to stop running current through one set of wires and run it through the other? 

If you think about it for a second, the ideal direction for the force that we want to apply is for it to be tangential to the rotor like this: 

INSERT PICTURE OF MAGNETIC FORCE TANGENTIAL TO TORQUE.

This maximizes torque on the rotor and makes it so that we  


## 3. How does FOC do that?

Aligning and why it's useful. discuss clarke, park, etc.


- **Definition:** $K_V$ is typically expressed as the number of revolutions per minute (rpm) the motor achieves per volt under no load.
- **Units:** rpm/V.
- **Interpretation:** For instance, if a motor has a $K_V$ of 1000 rpm/V, applying 1 volt ideally produces 1000 rpm, and 10 volts yield 10,000 rpm.

- **Definition:** $K_T$ represents the torque produced per ampere of current.
- **Units:** N·m/A.
- **Interpretation:** A motor with a $K_T$ of 0.05 N·m/A will generate 0.05 N·m of torque for every 1 ampere of current.

In ideal motors using SI units, the back EMF constant $K_E$ and the torque constant $K_T$ are numerically equal, reflecting energy conservation within the motor.


## 4. Digging deeper

### 4.1 Motor Schematic

### 4.2 Clarke, Park, and friends


### 4.3 Current loop and Speed loop

### 4.4 Position and Speed
- hall effect sensors
- encoders
- sliding mode observer
- ekf


## 5. Understanding the block diagram

Now we can take a look at a standard FOC diagram and try to make sense of it.

<div style={{textAlign: 'center'}}>

![FOC Block Diagram](/img/foc-block-diagram.png)

</div>

Everything that's here we've discussed at a high level, so let's break it down piece by piece.

First of all, on the right hand side in gray we have the path from the voltage supply to the inverter to the motor. Without this path, we wouldn't have a way of getting current through the inverter and into the motor. Simple enough, moving on.

Next we have the position feedback from the motor. Like we discussed before, this can come from either sensors inside the motor or something like a sliding mode observer (not shown in the diagram). These allow us to get an estimate of the angular speed to give to the speed controller as well as the angular position to give to the Park and inverse Park transforms.

The Clarke transform takes the current measurements, turns them into the $\alpha$-$\beta$ frame, and passes them to the Park transform. The Park transform takes the 

Next we have the outer speed loop. This takes the motor's measured speed as well as the commanded speed and runs it through a PI controller. The difference between the measured speed and the commanded speed is what is considered the error and is what we are trying to drive to zero. The output of this controller is run through the MTPA to check to make sure that the current being commanded is below the maximum limit, and the result is passed into the inner current loop. 

The current 

### 5.1 Timing
The current loops tend to run around 20KHz in practice. The speed loops tend to run anywhere from 100Hz to 2000Hz. 

The current loop needs to be fast enough that to the speed controller the current looks "stable". Running the current loop around 10 times faster is a heuristic often used in practice since it produces good enough results.

It's also important to note that even if you tried to run the speed loop faster, it won't make that much of a difference since the current will always be able to change much faster than speed can be modified since getting a motor to spin faster takes a lot longer than getting current to increase.

## 6. Closing
Hopefully this makes FOC a bit less mysterious. The concepts themselves aren't too crazy once you see what the different pieces are and how they fit together.

And remember that FOC is not going anywhere any time soon so if it takes you a couple of passes to understand everything, no big deal. 

Just keep the big picture in mind and everything will slowly become more clear.