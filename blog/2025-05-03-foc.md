---
slug: foc
title: Field Oriented Control (FOC)
authors: carlos
tags: [Motors, FOC]
draft: false
---

# Field Oriented Control (FOC)

Field Oriented Control is often considered a dark art filled with diagrams, math, and proofs by intimidation. 

Often people will show a diagram like this,

<div style={{textAlign: 'center'}}>

![FOC Diagram](/img/foc-block-diagram.png)

</div>

and pretend like it's self explanatory.

Not true!

However, once you get an understanding of what the different pieces are and what they are trying to do, you'll realize that it can be quite intuitive.

Let's dive in.

<!-- truncate -->

## 1. How does a motor work?

Let's start with the humble goal of understanding how a motor works.

When you run a current through a wire, you get a magnetic field around that wire as shown here,

![Magnetic field around a current-carrying wire](/img/faradays-law.jpg)

If I put a permanent magnet like a compass next to the wire, the magnetic field of the compass interacts with the magnetic field around the wire which causes the compass to be deflected. This is a result of the north and south poles of each field being attracted to each other and trying to align.

![Wire deflecting compass](/img/wire-deflecting-compass.gif)

A motor works in the same way.

![Brushless Motor](/img/BLDC-Motor.gif)

Inside of the motor there are both permanent magnets and wires. When you run a current through the wires inside the motor, the magnetic field of the wire interacts with the magnetic field of the permanent magnets -- just like the compass and wire we talked about before.

As you can see in the image above, there are two main parts of a motor: a rotor and a stator. 

The rotor is free to rotate and the stator is stationary.

The permanent magnets are attached to the rotor and the wire is wrapped around specific parts of the stator.

Now if I start to run current through the wire, I get a magnetic field that starts to interact with the magnetic field of the permanent magnets. Since the permanent magnets on the rotor are free to rotate, the rotor will rotate to try to align its magnetic field with the one created by the wire. And so, we get a rotation!

This type of motor is called a brushless DC motor and a variant of it called a Permanent Magnet Synchronous Motor (PMSM) is what we'll be focusing on in this post.

Before we move on, you might have noticed that in the motor image above current is always flowing through two of the wires. This is because one of the wires always interacts with the south pole (blue in the image) and the other wire interacts with the north pole (red). You can think of this as one magnetic field "pushing" while the other is "pulling" since two poles of the same polarity repel each other while poles of opposite polarity attract.

Lastly, eepending on the motor design, there may also be sensors inside the motor that provide position data like hall-effect sensors or encoders. We'll touch on these later.

---

## 2. The Relationship Between Speed & Voltage

The motor’s speed—typically measured as the angular velocity $\omega$ (in radians per second) or in revolutions per minute (rpm)—is primarily governed by the voltage applied to the motor. As the motor spins, it generates a back electromotive force (back EMF) that is proportional to its speed:

$$
V = K_E \cdot \omega
$$

where:
- $V$ is the applied voltage (in Volts, V),
- $\omega$ is the angular velocity (in rad/s),
- $K_E$ is the back EMF constant (in V/(rad/s)).

Under no-load conditions, the back EMF nearly equals the applied voltage, linking voltage directly to speed.

---

## 3. Introducing $K_V$ and $K_T$

### $K_V$: The Motor Velocity Constant

- **Definition:** $K_V$ is typically expressed as the number of revolutions per minute (rpm) the motor achieves per volt under no load.
- **Units:** rpm/V.
- **Interpretation:** For instance, if a motor has a $K_V$ of 1000 rpm/V, applying 1 volt ideally produces 1000 rpm, and 10 volts yield 10,000 rpm.

### $K_T$: The Motor Torque Constant

- **Definition:** $K_T$ represents the torque produced per ampere of current.
- **Units:** N·m/A.
- **Interpretation:** A motor with a $K_T$ of 0.05 N·m/A will generate 0.05 N·m of torque for every 1 ampere of current.

In ideal motors using SI units, the back EMF constant $K_E$ and the torque constant $K_T$ are numerically equal, reflecting energy conservation within the motor.

---

## 4. Deriving the Relationship Between $K_T$ and $K_V$

### 4.1 Converting $K_V$ to SI-Compatible Units

$K_V$ is typically given in rpm/V, but for consistency with SI units (where angular velocity is in rad/s), we need to convert:

$$
\omega = \text{rpm} \times \frac{2\pi}{60}
$$

If the motor’s speed per volt is $K_V$ rpm/V, then in SI units the speed per volt becomes:

$$
K_V^{\prime} = K_V \times \frac{2\pi}{60}
$$

### 4.2 Relating Back EMF to Motor Speed

The back EMF $E$ generated in the motor is given by:

$$
E = K_E \cdot \omega
$$

Under no-load conditions, the applied voltage $V$ almost equals the back EMF:

$$
V \approx K_E \cdot \omega
$$

Thus, for a given voltage, the speed is approximately:

$$
\omega \approx \frac{V}{K_E}
$$

Considering the SI conversion, where the no-load speed per volt is $K_V^{\prime}$:

$$
\frac{V}{K_E} = K_V^{\prime} \cdot V
$$

By canceling $V$ (assuming $V \neq 0$), we obtain:

$$
K_E = \frac{1}{K_V^{\prime}}
$$

Replacing $K_V^{\prime}$ with the converted form gives:

$$
K_E = \frac{1}{K_V \times \frac{2\pi}{60}} = \frac{60}{2\pi K_V}
$$

### 4.3 Establishing the Relationship with $K_T$

For an ideal motor, energy conservation dictates that the electrical power equals the mechanical power (ignoring losses):

$$
I \cdot V = T \cdot \omega
$$

Substitute the expressions $T = K_T \cdot I$ and $V = K_E \cdot \omega$:

$$
I \cdot (K_E \cdot \omega) = (K_T \cdot I) \cdot \omega
$$

Canceling $I$ and $\omega$ (assuming they are non-zero):

$$
K_E = K_T
$$

Given the earlier result for $K_E$, it follows that:

$$
K_T = \frac{60}{2\pi K_V}
$$

---

## 5. On to that black diagram

Now we can take a look at a standard FOC diagram and try make sense of it. A common version of the diagram looks like this,

<div style={{textAlign: 'center'}}>

![FOC Block Diagram](/img/foc-block-diagram.png)

</div>

Everything that's here we've discussed at a high level, so let's break it down piece by piece.

First of all, on the right hand side in gray we have the path from the voltage supply to the inverter to the motor. This is common to all BLDC and PMSM motors so there isn't anything FOC related here. 

Next we have the outer speed loop. This takes an estimate of the motor's position and speed and runs it through a PI controller that is fed into the inner current loop controller. Depending on your motor and motor controller, the motor position and speed estimate could come from:
- An encoder sensor inside the motor
- A hall effect sensor inside the motor
- A resolver sensor inside the motor
- An estimator like a sliding mode observer or Extended Kalman Filter

