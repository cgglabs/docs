---
slug: foc
title: Field Oriented Control (FOC)
authors: carlos
tags: [Motors, FOC]
draft: false
---

# Field Oriented Control (FOC)

Field Oriented Control is often considered a dark art filled with diagrams, math, and proofs by intimidation. 

Often people will show a diagram like this,

<div style={{textAlign: 'center'}}>

![FOC Diagram](/img/foc-block-diagram.png)

</div>

and pretend like it's self explanatory.

Not true!

However, once you get an understanding of what the different pieces are and what they are trying to do, you'll realize that it can be quite intuitive.

Let's dive in.

<!-- truncate -->

## 1. How does a motor work?

Let's start with the humble goal of understanding how a motor works.

When you run a current through a wire, you get a magnetic field around the wire.

<div style={{textAlign: 'center'}}>
![Magnetic field around a current-carrying wire](/img/faradays-law.jpg)
</div>

If I put a permanent magnet like a compass next to the wire, the magnetic field of the compass interacts with the magnetic field around the wire which causes the compass to be deflected. 

<div style={{textAlign: 'center'}}>
![Wire deflecting compass](/img/wire-deflecting-compass.gif)
</div>

This is a result of the north and south poles of each field being attracted to each other and trying to align.

A motor works in the same way.

<div style={{textAlign: 'center'}}>
![Brushless Motor](/img/BLDC-Motor.gif)
</div>

Inside of the motor there are both permanent magnets and wires. When you run a current through the wires inside the motor, the magnetic field of the wire interacts with the magnetic field of the permanent magnets -- just like the compass and wire we talked about before.


### 1.1 Motor Terminology
There are two main parts of a motor: a rotor and a stator. 

<div style={{textAlign: 'center'}}>
![PMSM](/img/pmsm.png)
</div>

The rotor is free to rotate and the stator is stationary.

The permanent magnets are attached to the rotor and the wire is wrapped around specific parts of the stator.

Now if I start to run current through the wire, I get a magnetic field that starts to interact with the magnetic field of the permanent magnets. Since the permanent magnets on the rotor are free to rotate, the rotor will rotate to try to align its magnetic field with the one created by the wire. 

And so, we get a rotation. Success!

This type of motor is called a Brushless DC motor (BLDC) and a variant of it called a Permanent Magnet Synchronous Motor (PMSM) is what we'll be focusing on in this post.

Depending on the motor design, there may also be sensors like hall-effect sensors or encoders inside the motor that provide position data. We'll touch on these later.


## 2. How to spin efficiently
Okay, so we know that putting current through the motor wires makes the motor spin, but how do we know when to stop running current through one set of wires and run it through a different set of wires so that the motor can keep spinning? 

If you take a step back for a second and think about what we want to do, the ideal direction for the force that we want to apply is for it to be tangential to the rotor like this: 

TODO: INSERT PICTURE OF MAGNETIC FORCE TANGENTIAL TO TORQUE.

This maximizes the torque applied to the rotor and makes it so that all of the force (and energy!) that we use goes to achieving our goal of rotating the rotor. 

So if we can get the magnetic fields created by the currents in the wire to interact with the permanent magnets in such a way that the magnetic force is applied tangentially to the rotor, then we know we are driving the motor in an efficient way.

## 3. How does FOC do that?

**The core idea of FOC is to continuously adjust the stator currents so that the magnetic field they produce is always 90° orthogonal to the rotor’s field.**

If you only take one thing away from reading this, let it be that previous statement.

The goal of all of the fancy math, sensors, and PI controllers is to make sure that statement holds as close to true as possible at all times during the motor's operation.

*FOC does this by converting to a frame of reference where it is easy to compare the stator current magnetic field to the rotor magnetic field.* 

Once you have an easy way of comparing the two magnetic fields, you can start to do controls and move the stator current magnetic field so that it "pushes" the rotor's magnetic field in a faster or slower way -- thus varying the speed of the motor. 

To see more clearly how FOC is doing this, we have to dig a little deeper.

## 4. Digging deeper

In this section we're going to get into the specifics of FOC along with all the math, etc. 

Our goal is to get a smooth sinusoidal wave like this to flow through the windings of the motor
<div style={{textAlign: 'center'}}>

![Smooth FOC](/img/pmsm_3_phase.gif)

</div>

The green, red, and dark blue lines are current vectors representing the current flowing through each winding and the cyan line is the resulting current vector where we can assume the magnetic field is being generated around.

The important thing to see here is that the cyan vector is smoothly rotating around the circle which results in the magnetic field from the stator currents being applied tangentially to the permanent magnets like we want.

If this is continued properly, this leads the permanent magnets to always be in a state where the north poles are attracted to the south poles of the electromagnets while also being repelled from the north poles. However, every instance that goes by we change the stator current so that the north pole is slightly farther from the permanent magnet so that the permanent magnet is never able to catch up to the poles of the electromagnet. 

It might take a couple of reads for everything in this section to click, but just keep in mind the concepts from the previous section if you get stuck.

### 4.1 Motor Schematic
A PMSM motor can be modeled electrically as follows,

<div style={{textAlign: 'center'}}>

![Motor schematic](/img/motor-windings-schematic.png)

</div>

This is our initial frame of reference for the stator currents.

If we apply Kirchoff's current law at the point in the middle of where the 3 windings meet, we get the following equation,
$$
i_a(t) + i_b(t) + i_c(t) = 0
$$

*This equation is very important.*

What this is saying is that even though we have 3 axes (one for each winding that the current can flow through), we only have 2 degrees of freedom.

So why is this important?

### 4.2 Clarke, Park, and friends

What we are looking for is a way to represent the 3 phase currents as a single current vector. This would allow us to move that vector around the motor and have the magnetic field created by the stator current interact with the rotor magnetic field in a way that is easy for us to control. 

Remember when I said that we could convert the magnetic field generated by the stator currents in the stator frame of reference to one where it was easy to compare with the rotor magnetic field?

The Clarke and Park transforms allow us to do that.


#### 4.2.1 Clarke Transform

The Clarke transform maps the 3 stator current axes into 2 axes called $\alpha$ and $\beta$.
$$
\begin{aligned}
i_\alpha &= i_a, \\[6pt]
i_\beta  &= \frac{1}{\sqrt{3}}\bigl(i_a + 2\,i_b\bigr).
\end{aligned}
$$

*The only reason we can map 3 axes into 2 axes without losing any information is because we only have 2 degrees of freedom (not 3) like we saw in the last section from Kirchoff's law.*

These equations might seem mysterious at first, but look a bit closer: the $\alpha$ axis is aligned with $a$ and axes $b$ and $c$ are projected into a single axis $\beta$ that is perpendicular to $\alpha$ (and thus also perpendicular to $a$). 

If you're familiar with linear algebra, this is doing what's called a change of basis. In fact, in matrix form it can be expressed like this,

$$
\begin{bmatrix}
i_\alpha \\[4pt]
i_\beta
\end{bmatrix}
=
\frac{2}{3}\,
\begin{bmatrix}
1 & -\tfrac12 & -\tfrac12 \\[4pt]
0 & \tfrac{\sqrt{3}}{2} & -\tfrac{\sqrt{3}}{2}
\end{bmatrix}
\begin{bmatrix}
i_a \\[4pt]
i_b \\[4pt]
i_c
\end{bmatrix}
$$

Geometrically, this gets us to here.

<div style={{textAlign: 'center'}}>

![alpha beta frame](/img/foc-alpha-beta-frame.gif)

</div>

That's a good start, but this would still require us to control two sinusoidal waves when doing control. 

Can we make the control easier with another change of reference frame?

#### 4.2.2 Park Transform
It turns out that we can.

If you think about it, the sinusoidal waves are coming from the fact that in the current frame of reference, the current vector is rotating.

But what if we make the entire frame of reference rotate?

If we can transform the alpha-beta frame into a frame of reference that rotates, then from this new frame of reference, the current is not rotating. In fact, it would look stationary.

What we want is something like this:

<div style={{textAlign: 'center'}}>

![alpha beta frame](/img/foc-iq-id-frame.gif)

</div>

This is what the Park transform gives us.

$$
\begin{bmatrix}
i_d \\
i_q
\end{bmatrix}
=
\begin{bmatrix}
\cos\theta & \sin\theta \\
-\sin\theta & \cos\theta
\end{bmatrix}
\begin{bmatrix}
i_\alpha \\
i_\beta
\end{bmatrix}
$$

By doing another change of basis, we can make the signals that we want to control look as though they are DC signals. 

This is great, because controlling DC signals is straightforward. 

#### 4.2.3 Inverse Transforms
An important feature of the Clarke and Park transforms is that they can be inverted. Remember, we didn't lose any information so we should be able to "undo" the transformation.


Rearranging the Park transformation above we can solve for the Inverse Park Transform to get,
$$
\begin{bmatrix}
i_\alpha \\[4pt]
i_\beta
\end{bmatrix}
=
\begin{bmatrix}
\cos\theta & -\sin\theta \\[6pt]
\sin\theta & \;\;\cos\theta
\end{bmatrix}
\begin{bmatrix}
i_d \\[4pt]
i_q
\end{bmatrix}
$$


Similarly for the inverse Clarke transform we get,
$$
\begin{bmatrix}
i_a \\[4pt]
i_b \\[4pt]
i_c
\end{bmatrix}
=
\begin{bmatrix}
1 & 0 \\[6pt]
-\tfrac12 & \tfrac{\sqrt{3}}{2} \\[6pt]
-\tfrac12 & -\tfrac{\sqrt{3}}{2}
\end{bmatrix}
\begin{bmatrix}
i_\alpha \\[4pt]
i_\beta
\end{bmatrix}
$$




### 4.3 Current loop and Speed loop

### 4.4 Position and Speed
I'm going to keep this section short since the way you get a position and speed estimate of the rotor heavily depends on your specific motor.

Broadly, there are two ways you can get estimates for speed and position: sensored and unsensored.

In the unsensored case, you'll run the voltage and current values of each phase in the $\alpha$-$\beta$ frame into either a sliding mode observer or a Kalman filter of some kind. Sliding mode observers are more common since they tend to be easier to tune.

In the sensored case, you'll use either a hall effect sensor or an encoder to get the position of the motor. Hall effect sensors don't have as high of resolution as an encoder but they are good enough at low speeds where the back-emf  In either case, you can take the delta of subsequent readings to get an estimate for speed. 


Regardless of how you go about getting your estimates for speed and position, speed gets fed to the speed controller and position gets fed to the Park transform.

- hall effect sensors
- encoders
- sliding mode observer
- ekf

### 4.5 Space Vector Modulation


## 5. Understanding the block diagram

Now we can take a look at a standard FOC diagram and try to make sense of it.

<div style={{textAlign: 'center'}}>

![FOC Block Diagram](/img/foc-block-diagram.png)

</div>

Everything that's here we've discussed at a high level, so let's break it down piece by piece.

First of all, on the right hand side in gray we have the path from the voltage supply to the inverter to the motor. Without this path, we wouldn't have a way of getting current through the inverter and into the motor. Simple enough, moving on.

Next we have the position feedback from the motor. Like we discussed before, this can come from either sensors inside the motor or something like a sliding mode observer (not shown in the diagram). These allow us to get an estimate of the angular speed to give to the speed controller as well as the angular position to give to the Park and inverse Park transforms.

The Clarke transform takes the current measurements, turns them into the $\alpha$-$\beta$ frame, and passes them to the Park transform. The Park transform takes the 

Next we have the outer speed loop. This takes the motor's measured speed as well as the commanded speed and runs it through a PI controller. The difference between the measured speed and the commanded speed is what is considered the error and is what we are trying to drive to zero. The output of this controller is run through the MTPA to check to make sure that the current being commanded is below the maximum limit, and the result is passed into the inner current loop. 

The current 

### 5.1 Practical Considerations
FOC requires relatively powerful microcontrollers in practice due to how fast the PI loops need to be as well as the math that they are performing.

The current loops tend to run around 20KHz in practice while the speed loop tends to run anywhere from 100Hz to 2000Hz. 

The current loop needs to be fast enough that to the speed controller the current looks "stable". Running the current loop around 10 times faster is a heuristic often used in practice since it produces good enough results.

It's also important to note that even if you tried to run the speed loop faster, it won't make that much of a difference since the current will always be able to change much faster than speed can be modified since getting a motor to spin faster takes a lot longer than getting current to increase.

## 6. Closing
Hopefully this makes FOC a bit less mysterious. The concepts themselves aren't too crazy once you see what the different pieces are and how they fit together.

And remember that FOC is not going anywhere any time soon so if it takes you a couple of passes to understand everything, no big deal. 

Just keep the big picture in mind and everything will slowly become more clear.

![BLDC Mag field](/img/bldc-mag-field.gif)